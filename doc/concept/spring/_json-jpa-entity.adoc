:includedir: ../../..
:relrootdir: ../../..
= JsonJpaEntity

Entities are fundamental classes of an application's domain model that define the properties and methods of objects used by the backend.
Within the class, fields are marked with specific annotations to define their storage, such as `@Column` for simple data or `@ElementCollection` for collections of data.
They are often linked to one another through relational annotations, including `@ManyToOne`, `@OneToMany`, and `@ManyToMany`.

Entities act as a bridge between the programming code and the database.
Each entity class typically corresponds to a database table defined in a `Liquibase` script.

Entities act as a definition for the JSON serialization in the REST endpoints.

== Properties

include::{includedir}/doc/concept/spring/_json-jpa-entity-id.adoc[leveloffset=2]

include::{includedir}/doc/concept/spring/_json-jpa-entity-version.adoc[leveloffset=2]

include::{includedir}/doc/concept/spring/_json-jpa-entity-column-string.adoc[leveloffset=2]

include::{includedir}/doc/concept/spring/_json-jpa-entity-column-long.adoc[leveloffset=2]

include::{includedir}/doc/concept/spring/_json-jpa-entity-column-date.adoc[leveloffset=2]

include::{includedir}/doc/concept/spring/_json-jpa-entity-column-time.adoc[leveloffset=2]

== Collections

Collections with `@ElementCollection` are simpler than `@OneToMany` relationships when:

* The collection contains basic types (e.g. `String`, `Long` or enumerations) rather than entities.
* The elements don't need their own identity (no separate ID column).
* The elements are completely dependent on the parent entity lifecycle.
* No bidirectional navigation from element to parent is needed.

include::{includedir}/doc/concept/spring/_json-jpa-entity-collection-string.adoc[leveloffset=2]

== Relations

A `@ManyToOne` relationship represents an association where multiple child entities can reference a single parent entity.
This is the owning side of the relationship, meaning the foreign key column is stored in the child entity's table.

A `@OneToMany` relationship represents an association where one parent entity owns a collection of related child entities.
This is typically the inverse side of a `@ManyToOne` relationship and is used with bidirectional mappings.

include::{includedir}/doc/concept/spring/_json-jpa-entity-relation-many-to-one.adoc[leveloffset=2]

include::{includedir}/doc/concept/spring/_json-jpa-entity-relation-one-to-many.adoc[leveloffset=2]

== Operations

Entities are designed to implement immutability to minimize side effects.
The following techniques support this design approach.

. Change identity without mutating the original object using the `withId` semantics.

. Minimize muatating setter, i.e. provide setter only for properties that must be changed in a controller.
JPA and Jackson can still use reflection to set fields directly.

. Initialization with JSON structures only, i.e. logic and tests use the same method for creating entities.
Use package visibility for constructors.

Entities implement several key operations for lifecycle management and data integrity:

**equals**::
Compares ID and version properties only to determine identity equality.
May not be overidden by subclasses.

**extraJson**::
Customizes JSON serialization through `@JsonAnyGetter` to include derived or transformed data.
May be customized by subclasses.

**hashCode**::
Uses ID and version properties only.
May not be overidden by subclasses.

**isEqual**::
Compares all properties except ID and version to determine semantic equality.
Must be implemented by subclasses.

**isPersisted**::
Returns true after saved to database.
May not be overidden by subclasses.

**toString**::
Provides a string representation for logging and debugging.
May be customized by subclasses.

**verify**::
Validates entity state before persistence, checking business rules and constraints and throws a `IllegalArgumentException` if entity state is invalid.
May be customized by subclasses.

**withId**::
Creates a copy of the entity with a different ID while preserving all other properties.
Must be implemented by subclasses.

== Tests

The test approach uses a classic unit test strategy with no dependency injection or database dependencies.
They use mocks when necessary.
They are completely isolated and are fast and parallelizable.

Tests validate

- identity semantics
- immutability patterns
- serialization with JSON
- constraint validation

