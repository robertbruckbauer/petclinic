:includedir: ../../..
:relrootdir: ../../..
= JsonJpaRestController

A subclass of `JsonJpaRestController` implements the logic for the REST API for an entity.
The goal is to avoid saving records to the database that endanger data integrity through incorrect user input or faulty client programming.

Operations for the REST interfaces are dynamically generated by _Spring Data REST_ based on the repositories generated by _Spring Data JPA_.
They run within a transaction and can be aborted with an exception.

TIP: See the
https://docs.spring.io/spring-data/rest/reference[Spring Data REST reference guide]
and
https://docs.spring.io/spring-data/jpa/reference[Spring Data JPA reference guide]
for more information.

A _Repository Event Handler_ is a mechanism for intercepting and customizing CRUD operations on entities.
Callback methods act as flexible extension points without modifying the endpoint behavior.
They restrict the value range of properties.
They check dependencies of properties within the record or with records in other tables at controller layer.

A _Collection Resource_ represents a list of elements.
It is queried with a `GET` operation.
A new _Item Resource_ is created with a `POST` operation.

An _Item Resource_ represents exactly one element.
It is queried with a `GET` operation.
An _Item Resource_ can be modified with a `PUT` and `PATCH` operation.
An _Item Resource_ is deleted with a `DELETE` operation.

An _Association Resource_ represents a relationship to another _Item Resource_.
It is queried with a `GET` operation.
A new _Item Resource_ is added with a `PUT` operation.
An existing _Item Resource_ is removed with a `DELETE` operation.

A _Search Resource_ returns all query methods provided by a repository.
It can only be queried with a `GET` operation.

A _Query Method Resource_ executes a query method.
It can only be queried with a `GET` operation.

_Versioning_ is a mechanism to ensure data integrity in the database.
The version from the JPA data model is translated into an `ETag` header.

_Paging_ is a mechanism that returns a large collection resource in parts (pages).
The individual subsets are navigably linked together.

_Sorting_ means that the order within a collection resource is determined by a specific sorting criterion.

With a _Projection_, a view can be applied to a resource.
An _Excerpt_ is a _Projection_ that is automatically applied to a _Collection Resource_.

== Properties

=== eventPublisher

The singleton instance of an `ApplicationEventPublisher` is used to provide all database changes as messages for other components in this server process.

=== transactionTemplate

The instance of a `TransactionTemplate` is used to validate incoming data, complete it if necessary, or supplement it before it is written to the database.

== Operations

=== beforeCreateTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=beforeCreateTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *before* saving a new record.
The method can modify the incoming record.
The callback method expects a `Void`.

=== afterCreateTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=afterCreateTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *after* saving a new record.
The callback method expects a `Void`.

=== beforeSaveTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=beforeSaveTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *before* saving an already existing record.
The method can modify the incoming record.
The callback method expects a `Void`.

=== afterSaveTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=afterSaveTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *after* saving an already existing record.
The callback method expects a `Void`.

=== beforeDeleteTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=beforeDeleteTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *before* deleting a record.
The callback method expects a `Void`.

=== afterDeleteTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=afterDeleteTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *after* deleting a record.
The callback method expects a `Void`.

=== beforeLinkSaveTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=beforeLinkSaveTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *before* saving a relation in this record. +
The method can modify the incoming record.
The callback method expects a `Void`.

=== afterLinkSaveTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=afterLinkSaveTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *after* saving a relation in this record.
The callback method expects a `Void`.

=== beforeLinkDeleteTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=beforeLinkDeleteTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *before* deleting a relation in this record.
The callback method expects a `Void`.
The callback method expects a `Void`.

=== afterLinkDeleteTransaction

[source,java,options="nowrap"]
----
include::{includedir}/lib/backend-data/src/main/java/esy/rest/JsonJpaRestControllerBase.java[tags=afterLinkDeleteTransaction, indent=0]
----

This operation returns a callback method for a `TransactionTemplate` in an individual implementation.
The callback method is executed *after* deleting a relation in this record.
The callback method expects a `Void`.

== Tests

The test approach relies on the concept of component integration with `@SpringBootTest` and verifies rest endpoints with an embedded database.
Liquibase applies all changelog scripts so tables, constraints, indexes, etc. exist.

Tests automatically generate documentation snippets configured in `@BeforeEach` with pretty-printed JSON structures.

Tests are strictly ordered using `@TestMethodOrder` with `@Order` annotations.
Each test builds upon previous test state.
Changes persist between tests and are cleaned up at the end of the suite.

.Consequences
****
[.lead]
Positive:

Minimal lines of code::
Single precondition, single cleanup, no repeated inserts.

Fast execution::
Avoids per-test database setup and repeated cleanup.

Realistic narrative::
Order matches how the API is used; snippet generation is naturally story-driven.

Reduced duplication::
Shared state reused across steps.

[.lead]
Negative:

Failure cascades::
If an early step fails, many later tests will fail too (reduced signal quality).

lower isolation::
Tests cannot be reliably executed individually.

Harder parallelization::
Ordered tests limit parallel execution and sharding.

Hidden state coupling::
Later assertions may fail due to earlier setup issues rather than endpoint logic.
****

We accept these consequences because this test level serves as a scenario-based component integration test focused on the correct interaction of endpoints across the resource lifecycle and on producing stable documentation snippets.
See also test approach for entities and repositories.
